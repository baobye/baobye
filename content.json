{"meta":{"title":"baobye的博客","subtitle":"JAVA软件工程师","description":null,"author":"曹子龙","url":"http://baobye.com"},"pages":[{"title":"","date":"2018-06-27T15:04:44.552Z","updated":"2018-06-27T15:04:44.552Z","comments":true,"path":"tags/index.html","permalink":"http://baobye.com/tags/index.html","excerpt":"","text":"title: tagsdate: 2015-10-20 06:49:50type: “tags”comments: false"}],"posts":[{"title":"Redis安装、集群搭建","slug":"Redis安装、集群搭建","date":"2018-06-28T02:53:08.000Z","updated":"2018-06-28T04:27:37.649Z","comments":true,"path":"2018/06/28/Redis安装、集群搭建/","link":"","permalink":"http://baobye.com/2018/06/28/Redis安装、集群搭建/","excerpt":"","text":"redis单节点的安装与启动首先下载redis的安装包，http://download.redis.io/releases/redis-4.0.0.tar.gz 123456tar -zxvf redis-4.0.0.tar.gz cd redis-4.0.0makemake install --prefix /usr/local/rediscp redis.conf /usr/local/redis/binvim redis.conf 默认是no，redis server在前端进行，关闭shell之后，server进程就被终止了，修改为yes之后，成为后台守护进程12daemonize yescd /usr/local/redis/bin 通过redis.conf启动redist server，不指定启动配置文件会读取默认配置1./redis-server redis.conf 启动redis交互式命令窗口1./redis-cli 查看redis启动状态，在交互式命令窗口下12redis 127.0.0.1:6379&gt; ping PONG 返回PONG说明redis已经安装成功。其中127.0.0.1可以在redis.conf中修改bind属性，最好将其改成本机实际的IP地址，例如10.4.121.202，否则在用client连接server的时候会出现问题在/usr/local/redis/bin目录下，还有以下的命令脚本 123redis-benchamrk # Redis性能测试工具redis-check-aof # AOF文件修复工具redis-check-dump # RDB文件检查工具 redis集群的部署与使用集群的搭建依赖ruby环境，首先安装ruby的运行环境 12yum -y install rubyyum -y install rubygems ruby和redis的接口程序1gem install redis 如果下载不下来可以修改一下gems的源12gem sources --remove https://rubygems.org/gem sources -a https://ruby.taobao.org/ 如果因为代理问题无法通过gem install的方式下载，可以直接下载.gem文件手动安装下载地址 https://rubygems.org/downloads/redis-3.3.3.gemgem install –local redis-3.3.3.gem创建redis集群，至少需要3个主节点，若每个主节点有一个从节点，则需要6个节点 创建集群的节点，集群规划为两台物理机，6个节点：物理机10.4.121.202, 7001 7002 7003; 物理机10.4.121.203, 7001 7002 7003 1234cd /usr/localmkdir redis-clustercd redis-clustermkdir 7001 (7002 ...) 把redis安装目录bin下的文件拷贝到每个700X目录内，每台机器伪造3个节点，端口都是7001~70031cp /usr/local/redis/bin /usr/local/redis-cluster/7001 (7002 ...) 其实主要拷贝的文件如下: 1234/usr/local/redis-*/src/mkreleasehdr.sh /usr/local/redis-*/src/redis-server /usr/local/redis-*/src/redis-sentinel /usr/local/redis-*/src/redis.conf 将各个节点的redis安装完毕之后，修改每个节点的配置文件 1vim redis.conf 默认ip为127.0.0.1 最好改为其他节点机器可访问的ip，否则创建集群时无法访问对应的端口，无法创建集群，所有节点都在一个机器上的伪集群除外 1234bind 10.4.121.202 (10.4.121.203) port 7001 (7002 7003) daemonize yes # redis后台运行cluster-enabled true 其他可选的配置的属性，可不配 1234pidfile /var/run/redis_7001.pid # pidfile文件对应7001,7002,7003cluster-config-file nodes_7001.conf # 集群的配置 配置文件首次启动自动生成 7001,7002,7003cluster-node-timeout 15000 # 请求超时，默认15秒appendonly yes # 开启aof日志，有需要就开启，每次写操作都会记录一条日志 分别启动每个节点的redis服务，注意，启动的时候必须使用./，像下面的命令，分两步操作。不然你会发现后台根本没有这个进程。 12cd /usr/local/redis-cluster/7001/./redis-server redis.conf 检查启动情况 1ps aux | grep redis 启动正常，则进入redis源码目录下 123cd /usr/zhangqiang/redis-4.0.0/srccp redis-trib.rb /usr/local/redis-clustercd /usr/local/redis-cluster 执行创建集群命令 1./redis-trib.rb create --replicas 1 10.4.121.202:7001 10.4.121.202:7002 10.4.121.202:7003 10.4.121.203:7001 10.4.121.203:7002 10.4.121.202:7003 如果出现下面的问题： [ERR] Node 10.4.121.202:7001 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0.将每个节点下 /usr/local/redis-cluster/7001 内的.aof、.rdb等本地备份文件删除将新Node的集群配置文件nodes.conf删除，在/usr/local/redis-cluster/7001内。即redis.conf里面的cluster-config-file(如果提前配置过的话)将 /usr/local/redis-cluster 内的node.conf删除(如果有的话)10.4.121.202:7001&gt; flushdb 清空当前数据库(可省略)重新关闭servers，重新启动所有的节点，再次执行集群创建脚本 其中dump.rdb是由Redis服务器自动生成的。默认情况下，每隔一段时间redis服务器程序会自动对数据库做一次遍历，把内存快照写在一个叫dump.rdb的文件里，这个持久化机制叫做SNAPSHOT。有了SNAPSHOT后，如果服务器宕机，重新启动redis服务器程序时redis会自动加载dump.rdb，将数据库状态恢复到上一次做SNAPSHOT时的状态。 当出现下面的提示说明集群创建成功 Creating clusterPerforming hash slots allocation on 6 nodes…Using 3 masters:10.4.121.202:700110.4.121.203:700110.4.121.202:7002Adding replica 10.4.121.203:7002 to 10.4.121.202:7001Adding replica 10.4.121.202:7003 to 10.4.121.203:7001Adding replica 10.4.121.202:7003 to 10.4.121.202:7002M: 55235f44db4afc8c5d596bd09fd11a3124008af6 10.4.121.202:7001 slots:0-5460 (5461 slots) masterM: b03994af450e48c1c1bf2a9723fcddd32a633a6e 10.4.121.202:7002 slots:10923-16383 (5461 slots) masterS: 4ba458ca30ebf1418940433c1a2153a690840b03 10.4.121.202:7003 replicates 8e75ff12899683e9acea855cf27f536bc02d779aM: 8e75ff12899683e9acea855cf27f536bc02d779a 10.4.121.203:7001 slots:5461-10922 (5462 slots) masterS: 444a7410ccff7aacc92517102891f24b50449fdf 10.4.121.203:7002 replicates 55235f44db4afc8c5d596bd09fd11a3124008af6S: 4ba458ca30ebf1418940433c1a2153a690840b03 10.4.121.202:7003 replicates b03994af450e48c1c1bf2a9723fcddd32a633a6eCan I set the above configuration? (type ‘yes’ to accept): yesNodes configuration updatedAssign a different config epoch to each nodeSending CLUSTER MEET messages to join the clusterWaiting for the cluster to join….Performing Cluster Check (using node 10.4.121.202:7001)M: 55235f44db4afc8c5d596bd09fd11a3124008af6 10.4.121.202:7001 slots:0-5460 (5461 slots) master 1 additional replica(s)M: b03994af450e48c1c1bf2a9723fcddd32a633a6e 10.4.121.202:7002 slots:10923-16383 (5461 slots) master 1 additional replica(s)S: 4ba458ca30ebf1418940433c1a2153a690840b03 10.4.121.202:7003 slots: (0 slots) slave replicates b03994af450e48c1c1bf2a9723fcddd32a633a6eS: 444a7410ccff7aacc92517102891f24b50449fdf 10.4.121.203:7002 slots: (0 slots) slave replicates 55235f44db4afc8c5d596bd09fd11a3124008af6M: 8e75ff12899683e9acea855cf27f536bc02d779a 10.4.121.203:7001 slots:5461-10922 (5462 slots) master 0 additional replica(s)[OK] All nodes agree about slots configuration.Check for open slots…Check slots coverage…[OK] All 16384 slots covered.登陆任意redis结点查询集群中的节点情况 cd /usr/local/redis-cluster/7001./redis-cli -h 10.4.121.202 -p 700110.4.121.202:7001&gt; CLUSTER INFO 以下是查询出的节点情况cluster_state:okcluster_slots_assigned:16384cluster_slots_ok:16384cluster_slots_pfail:0cluster_slots_fail:0cluster_known_nodes:5cluster_size:3cluster_current_epoch:5cluster_my_epoch:1cluster_stats_messages_ping_sent:904cluster_stats_messages_pong_sent:991cluster_stats_messages_sent:1895cluster_stats_messages_ping_received:987cluster_stats_messages_pong_received:904cluster_stats_messages_meet_received:4cluster_stats_messages_received:1895Java/Scala连接redis客户端：JedisSBT地址： libraryDependencies += “redis.clients” % “jedis” % “2.9.0”连接单节点import redis.clients.jedis.Jedis val jedis = new Jedis(“10.4.121.202”, 7001) import scala.collection.JavaConversions._ val map = new mutable.HashMapString, Stringmap.put(“name”, “zhangqiang”)map.put(“sex”, “male”) jedis.hmset(“info_zhangqiang”, map)连接池方式连接单节点import redis.clients.jedis._ val REDIS_HOST = “10.4.121.79”val REDIS_PORT = 6379// redis key 过期时间，单位秒val EXPIRE = 24 60 60// 可用连接实例的最大数目，默认值为8；//可用连接实例的最大数目，默认值为8；// 如果赋值为-1，则表示不限制；如果pool已经分配了maxActive个jedis实例，则此时pool的状态为exhausted(耗尽)。val MAX_TOTAL = 1024// 控制一个pool最多有多少个状态为idle(空闲的)的jedis实例，默认值也是8。val MAX_IDLE = 200// 等待可用连接的最大时间，单位毫秒，默认值为-1，表示永不超时。如果超过等待时间，则直接抛出JedisConnectionException；val MAX_WAIT = 10000// 连接超时时间val TIMEOUT = 30000// 在borrow一个jedis实例时，是否提前进行validate操作；如果为true，则得到的jedis实例均是可用的；val TEST_ON_BORROW: Boolean = true val config = new JedisPoolConfigconfig.setMaxTotal(MAX_TOTAL)config.setMaxIdle(MAX_IDLE)config.setMaxWaitMillis(MAX_WAIT)config.setTestOnBorrow(TEST_ON_BORROW) val pool = new JedisPool(config, REDIS_HOST, REDIS_PORT, TIMEOUT) val redisClient = pool.getResource redisClient.hset(“keyName”, “key”, “value”)// 设置key的过期时间，单位秒redisClient.expire(“keyName”, EXPIRE)redisClient.close() // 在程序结束时销毁连接池lazy val hook = new Thread { override def run = { println(“Execute hook thread: “ + this) pool.destroy() }}sys.addShutdownHook(hook.run)连接集群import redis.clients.jedis.{HostAndPort, JedisCluster} val jedisClusterNodes = new util.HashSetHostAndPortjedisClusterNodes.add(new HostAndPort(“10.4.121.202”, 7001))jedisClusterNodes.add(new HostAndPort(“10.4.121.202”, 7002))jedisClusterNodes.add(new HostAndPort(“10.4.121.202”, 7003))jedisClusterNodes.add(new HostAndPort(“10.4.121.203”, 7001))jedisClusterNodes.add(new HostAndPort(“10.4.121.203”, 7002))jedisClusterNodes.add(new HostAndPort(“10.4.121.203”, 7003))val clients = new JedisCluster(jedisClusterNodes) import scala.collection.JavaConversions._ val map = new mutable.HashMapString, Stringmap.put(“name”, “zhangqiang”)map.put(“sex”, “male”) clients.hmset(“info_zhangqiang”, map)异常处理异常1redis.clients.jedis.exceptions.JedisConnectionException: Could not get a resource from the pool at…Caused by: java.util.NoSuchElementException: Unable to validate object at…原因：当设置redis的TestOnBorrow属性为true时，validate有问题就会出现此异常。异常的意思是拿不到ping成功的Redis的链接。 ./redis-cli -h 10.4.121.79 -p 6379 10.4.121.79:6379&gt; ping(error) MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error. 可以看到是rdb文件持久化的问题。 vim redis.conf 找到下面的默认配置dbfilename dump.rdbdir ./ 发现存储快照的文件名是dump.rdb，执行命令的当前目录下。去到目录中发现文件都在，也没什么问题。干掉redis重启之后。再次测试。 ./redis-cli -h 10.4.121.79 -p 6379 10.4.121.79:6379&gt; pingPONG 发现ping成功了。然后再重新执行程序。异常不见了~","categories":[],"tags":[]},{"title":"markdown","slug":"markdown","date":"2018-06-28T01:08:40.000Z","updated":"2018-06-28T02:52:57.251Z","comments":true,"path":"2018/06/28/markdown/","link":"","permalink":"http://baobye.com/2018/06/28/markdown/","excerpt":"","text":"","categories":[],"tags":[]},{"title":"'my-first-blog'","slug":"my-first-blog","date":"2018-06-27T11:41:51.000Z","updated":"2018-06-27T15:19:12.936Z","comments":true,"path":"2018/06/27/my-first-blog/","link":"","permalink":"http://baobye.com/2018/06/27/my-first-blog/","excerpt":"","text":"","categories":[],"tags":[{"name":"tag1","slug":"tag1","permalink":"http://baobye.com/tags/tag1/"},{"name":"tag2","slug":"tag2","permalink":"http://baobye.com/tags/tag2/"},{"name":"tag3","slug":"tag3","permalink":"http://baobye.com/tags/tag3/"}]},{"title":"Hello World","slug":"hello-world","date":"2018-06-27T11:22:36.195Z","updated":"2018-06-27T15:19:03.080Z","comments":true,"path":"2018/06/27/hello-world/","link":"","permalink":"http://baobye.com/2018/06/27/hello-world/","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new \"My New Post\" More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","categories":[],"tags":[{"name":"tag1","slug":"tag1","permalink":"http://baobye.com/tags/tag1/"},{"name":"tag2","slug":"tag2","permalink":"http://baobye.com/tags/tag2/"},{"name":"tag3","slug":"tag3","permalink":"http://baobye.com/tags/tag3/"}]}]}